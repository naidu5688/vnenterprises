@using System.Text.Json
@{
    Layout = "~/Views/Shared/_SharedLayout_Employee.cshtml";
    var mobile = Model?.PhoneNumber ?? "";
    var kycStatus = Model?.KycStatus ?? "Pending";
    var customerid = Model?.CustomerId ?? "Pending";
}

<style>
    body {
        font-family: 'Segoe UI',sans-serif;
        background: #17362e;
    }

    .page-container {
        max-width: 1200px;
        margin: auto;
        padding: 25px;
        position: relative;
    }

    .kyc-status {
        position: absolute;
        top: 20px;
        right: 20px;
        padding: 5px 12px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
    }

    .kyc-pending {
        background-color: #d4af37;
        color: black;
    }

    .kyc-approved {
        background-color: green;
    }

    .kyc-rejected {
        background-color: red;
    }

    h3, h4 {
        color: #d4af37;
        margin-bottom: 15px;
    }

    label {
        color: #fff;
        font-size: 13px;
        margin-bottom: 4px;
        display: block;
    }

    .form-control {
        width: 100%;
        height: 38px;
        background: #1e4a37;
        border: 1px solid #d4af37;
        border-radius: 8px;
        color: white;
        padding: 0 10px;
        font-size: 13px;
    }

    .grid-3 {
        display: grid;
        grid-template-columns: repeat(3,1fr);
        gap: 18px;
    }

    .grid-4 {
        display: grid;
        grid-template-columns: repeat(4,1fr);
        gap: 18px;
    }

    .grid-2 {
        display: grid;
        grid-template-columns: repeat(2,1fr);
        gap: 15px;
    }

    button {
        border-radius: 8px;
        padding: 7px 14px;
        font-size: 13px;
        border: none;
        cursor: pointer;
    }

    .btn-primary {
        background: #d4af37;
        color: #17362e;
        font-weight: 600;
    }

    .btn-danger {
        background: #8d2525;
        color: white;
    }

    .image-upload-box {
        background: #1e4a37;
        border-radius: 10px;
        padding: 10px;
        text-align: center;
        height: 250px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 8px;
    }

    .image-preview {
        max-height: 150px;
        border-radius: 8px;
        cursor: zoom-in;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
    }

    th, td {
        border: 1px solid #d4af37;
        padding: 8px;
        text-align: center;
        color: white;
        font-size: 13px;
    }

    th {
        color: #d4af37;
    }

    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.75);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .modal-box {
        background: #17362e;
        border: 1px solid #d4af37;
        border-radius: 12px;
        padding: 20px;
        width: 550px;
    }

    .flex-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
</style>

<div class="page-container">

    <!-- CUSTOMER & KYC STATUS -->
    <div class="kyc-status" style="position: absolute; right: 150px; background-color: #d4af37; color: black;">
        CustomerId: @customerid
    </div>
    <div class="kyc-status @(kycStatus.ToLower() == "pending" ? "kyc-pending" : kycStatus.ToLower() == "approved" ? "kyc-approved" : "kyc-rejected")">
        KYC: @kycStatus
    </div>

    <h3>Customer Details</h3>

    <div class="grid-3">
        <div><label>First Name *</label><input id="firstName" class="form-control" value="@Model?.FirstName" placeholder="Enter First name"></div>
        <div><label>Last Name *</label><input id="lastName" class="form-control" value="@Model?.LastName" placeholder="Enter Last name"></div>
        <div><label>Phone *</label><input id="phone" class="form-control" value="@mobile" readonly></div>
        <div><label>Aadhaar *</label><input id="aadhaar" class="form-control" value="@Model?.aadharnumber" placeholder="Enter Aadhaar Number"></div>
        <div><label>PAN *</label><input id="pan" class="form-control" value="@Model?.pannumber" placeholder="Enter PAN Number"></div>
    </div>

    <br>

    <h4>Documents</h4>
    <div class="grid-4">
        @foreach (var d in new[] { ("aadhaarFront", "Aadhaar Front *", Model?.aadharfrontpath), ("aadhaarBack", "Aadhaar Back *", Model?.aadharbackpath), ("panFront", "PAN Front *", Model?.panfrontpath), ("panBack", "PAN Back (Optional)", Model?.panbackpath) })
        {
            <div class="image-upload-box" data-name="@d.Item1">
                <img class="image-preview" src="@d.Item3" style="display:@(string.IsNullOrEmpty(d.Item3) ? "none" : "block")">
                <input type="file" id="@d.Item1" style="display:none">
                <button class="btn-primary" onclick="document.getElementById('@d.Item1').click()">Upload</button>
                <button class="btn-danger" onclick="deleteImage('@d.Item1')">Delete</button>
                <span style="color:#d4af37">@d.Item2</span>
            </div>
        }
    </div>

    <br>

    <div class="flex-header">
        <h4>Credit Cards</h4>
        <button class="btn-primary" onclick="openCardModal()">+ Add Card</button>
    </div>

    <table id="cardTable">
        <thead>
            <tr>
                <th>Holder</th>
                <th>Number</th>
                <th>Expiry</th>
                <th>Type</th>
                <th>CVV</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <br>
    <button class="btn-primary" onclick="saveCustomer()">Save Customer</button>
    <button class="btn-primary" onclick="window.location.href='/Employee/AddTransaction?CustomerId=@Model?.CustomerId'">Add Transaction</button>
</div>

<div class="modal-overlay" id="cardModal">
    <div class="modal-box">
        <h4>Credit Card</h4>
        <div class="grid-2">
            <input id="cHolder" class="form-control" placeholder="Card Holder *">
            <input id="cNumber" class="form-control" maxlength="16" placeholder="Card Number *" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
            <input id="cExpiry" class="form-control" maxlength="5" placeholder="MM/YY *" oninput="formatExpiry(this)">
            <input id="cCVV" class="form-control" maxlength="3" placeholder="CVV *" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
            <select id="cType" class="form-control"></select>
            <select id="cActive" class="form-control">
                <option value="">-- Status --</option>
                <option value="true">Active</option>
                <option value="false">Inactive</option>
            </select>
        </div>

        <div style="text-align:right;margin-top:15px">
            <button class="btn-danger" onclick="closeCardModal()">Cancel</button>
            <button class="btn-primary" onclick="saveCard()">Save</button>
        </div>
    </div>
</div>

<script>
    const customerId = @Model?.CustomerId ?? 0;
    let cardTypes = [];
    let cards = @Html.Raw(JsonSerializer.Serialize(Model?.CreditCards ?? new List<object>()));
    cards = cards.map(c=>({
        NameOnCard:c.NameOnCard??"",
        CardNumber:c.CardNumber??"",
        ExpiryDate:c.ExpiryDate??"",
        CardCVV:c.CardCVV??"",
        CardTypeId:c.CardTypeId??"",
        CardTypeName:c.CardTypeName??"",
        IsActive:c.IsActive===true,
        IsExisting:true
    }));
    let editIndex = null;

    // Load card types
    fetch('/Employee/GetCardTypes').then(r=>r.json()).then(d=>{cardTypes=d; renderCards();});

    // IMAGE PREVIEW
    document.querySelectorAll('.image-upload-box input[type="file"]').forEach(input=>{
        input.addEventListener('change', e=>{
            const file = e.target.files[0];
            if(file){
                const img = input.closest('.image-upload-box').querySelector('.image-preview');
                img.src = URL.createObjectURL(file);
                img.style.display = 'block';
            }
        });
    });

    function deleteImage(id){
        const input = document.getElementById(id);
        input.value = "";
        const img = input.closest('.image-upload-box').querySelector('.image-preview');
        img.src = ""; img.style.display = "none";
    }

    // ---------------- CREDIT CARDS ----------------
    function renderCards(){
        const tbody=document.querySelector("#cardTable tbody");
        tbody.innerHTML="";
        if(cards.length===0){tbody.innerHTML='<tr><td colspan="7">No Credit Cards</td></tr>'; return;}
        cards.forEach((c,i)=>{
            let typeName = cardTypes.find(x=>x.id==c.CardTypeId)?.name || c.CardTypeName || '';
            tbody.innerHTML+=`<tr>
                <td>${c.NameOnCard}</td>
                <td>${c.CardNumber}</td>
                <td>${c.ExpiryDate}</td>
                <td>${typeName}</td>
                <td>${c.CardCVV}</td>
                <td>${c.IsActive?"Active":"Inactive"}</td>
                <td>
                    <button class="btn-primary" onclick="openCardModal(${i})">Edit</button>
                    ${c.IsExisting ? '' : `<button class="btn-danger" onclick="removeCard(${i})">Remove</button>`}
                </td>
            </tr>`;
        });
    }

    function openCardModal(index=null){
        editIndex=index;
        cType.innerHTML='<option value="">-- Select Card Type --</option>';
        cardTypes.forEach(x=>cType.innerHTML+=`<option value="${x.id}">${x.name}</option>`);
        if(index!==null){
            const c=cards[index];
            cHolder.value=c.NameOnCard; cNumber.value=c.CardNumber; cExpiry.value=c.ExpiryDate;
            cCVV.value=c.CardCVV; cType.value=c.CardTypeId; cActive.value=c.IsActive?'true':'false';
        }else{cHolder.value=cNumber.value=cExpiry.value=cCVV.value=cType.value=cActive.value='';}
        cardModal.style.display='flex';
    }
    function closeCardModal(){cardModal.style.display='none'; editIndex=null;}
    function saveCard(){
        if(!cHolder.value||!cNumber.value||!cExpiry.value||!cCVV.value||!cType.value||!cActive.value){alert('All fields mandatory'); return;}
        const card={NameOnCard:cHolder.value,CardNumber:cNumber.value,ExpiryDate:cExpiry.value,CardCVV:cCVV.value,CardTypeId:cType.value,CardTypeName:cType.options[cType.selectedIndex].text,IsActive:cActive.value==='true',IsExisting:false};
        if(editIndex!==null) cards[editIndex]=card; else cards.push(card);
        renderCards(); closeCardModal();
    }
    function removeCard(i){cards.splice(i,1); renderCards();}
    function formatExpiry(input){let v=input.value.replace(/[^0-9]/g,''); if(v.length>4)v=v.substring(0,4); if(v.length>=2){ let m=Math.min(12,Math.max(1,parseInt(v.substring(0,2)))); v=m.toString().padStart(2,'0')+v.substring(2);} input.value=v.length>2?v.substring(0,2)+'/'+v.substring(2):v;}

    // ---------------- SAVE CUSTOMER ----------------
    function saveCustomer(){
        const firstName=document.getElementById("firstName").value,
              lastName=document.getElementById("lastName").value,
              aadhaar=document.getElementById("aadhaar").value,
              pan=document.getElementById("pan").value;
        if(!firstName||!lastName||!aadhaar||!pan){alert('All fields mandatory');return;}

        const formData=new FormData();
        formData.append("CustomerId",customerId);
        formData.append("FirstName",firstName);
        formData.append("LastName",lastName);
        formData.append("PhoneNumber",mobile);
        formData.append("aadharnumber",aadhaar);
        formData.append("pannumber",pan);

        // Append images
        document.querySelectorAll('.image-upload-box input[type="file"]').forEach(input=>{
            if(input.files.length>0) formData.append(input.id,input.files[0]);
        });

        // Append credit cards
        cards.forEach((c,i)=>{
            formData.append(`CreditCards[${i}].NameOnCard`, c.NameOnCard);
            formData.append(`CreditCards[${i}].CardNumber`, c.CardNumber);
            formData.append(`CreditCards[${i}].ExpiryDate`, c.ExpiryDate);
            formData.append(`CreditCards[${i}].CardCVV`, c.CardCVV);
            formData.append(`CreditCards[${i}].CardTypeId`, c.CardTypeId);
            formData.append(`CreditCards[${i}].IsActive`, c.IsActive);
        });

        fetch('/Employee/AddCustomer',{method:'POST',body:formData})
        .then(r=>r.json())
        .then(res=>{
            if(res.result>0){alert('✅ Customer updated successfully'); location.reload();}
            else{alert('❌ '+(res.StatusMessage||'Something went wrong'));}
        }).catch(err=>alert('Error saving customer'));
    }
</script>
