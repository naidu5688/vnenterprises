@{
    Layout = "~/Views/Shared/_SharedLayout_Employee.cshtml";
    var userId = ViewBag.UserId;
}

<style>
    /* ================= SUMMARY ================= */
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 16px;
        margin: 20px;
    }

    .summary-card {
        background: linear-gradient(135deg, #065440, #0b6b55);
        color: #fff;
        padding: 20px;
        border-radius: 14px;
        text-align: center;
        
    }

    /* ================= FILTER BAR ================= */
    .filter-bar {
        display: grid;
        grid-template-columns: 2.5fr 1.2fr 1.2fr 1.5fr auto;
        gap: 12px;
        margin: 0 25px 20px;
        padding: 16px;
        background: #e9f2ef;
        border-radius: 14px;
        box-shadow: 0 6px 14px rgba(0,0,0,0.08);
    }

        .filter-bar input,
        .filter-bar select {
            height: 42px;
            padding: 0 12px;
            border-radius: 8px;
            border: 1px solid #cbded8;
        }

    .btn-primary {
        background: #17362e;
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 10px 18px;
        cursor: pointer;
    }

        .btn-primary:hover {
            background: #0f2a23;
        }

    /* ================= TABLE ================= */
    .table-wrapper {
        margin: 0 25px;
        border-radius: 14px;
        overflow: hidden;
        box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background: #0b6b55;
    }

    th {
        padding: 14px;
        color: #fff;
        font-size: 13px;
        text-align: center;
    }

    td {
        padding: 14px;
        text-align: center;
        font-size: 14px;
        border-bottom: 1px solid #edf2f0;
    }

     tbody {
        background: #dff1eb;
    } 

    tbody tr:hover {
        background: #dff1eb;
    }

    /* ================= PAGINATION ================= */
    #pagination {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin: 20px;
    }

        #pagination button {
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            background: #e0ece8;
            cursor: pointer;
        }

        #pagination .active-page {
            background: #3e806f;
            color: #fff;
        }

    /* ================= MODAL ================= */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 999;
    }

    /* modal container */
    .modal-box {
        background: #065440;
        padding: 22px;
        border-radius: 14px;
        width: 50%;
        /* IMPORTANT */
        max-height: 90vh; /* fit to screen */
        overflow-y: auto; /* enable scroll */
    }

        /* nice scrollbar (optional but recommended) */
        .modal-box::-webkit-scrollbar {
            width: 6px;
        }

        .modal-box::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.4);
            border-radius: 10px;
        }

    /* detail grid */
    .detail-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-top: 15px;
    }

    /* detail box */
    .detail-box label {
        font-size: 15px;
        margin-bottom: 4px;
        display: block;
        color: #e6f5f0;
    }

    .detail-box input {
        width: 100%;
        height: 38px;
        padding: 0 10px;
        border-radius: 8px;
        border: 1px solid #cbded8;
        background: #f4faf8;
    }
    /* modal header */
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        background: #0b6b55;
        padding-bottom: 10px;
        z-index: 2;
    }

        .modal-header h4 {
            color: white;
            font-size: 20px;
            margin: 0;
        }

    /* close icon */
    .close-btn {
        background: transparent;
        border: none;
        color: white;
        font-size: 22px;
        cursor: pointer;
        padding: 0 6px;
    }

    /* footer */
    .modal-footer {
        text-align: right;
        margin-top: 15px;
        position: sticky;
        bottom: 0;
        background: #0b6b55;
        padding-top: 10px;
    }

</style>

<div class="page-container">

    <!-- SUMMARY -->
    <div class="summary-grid">
        <div class="summary-card"><h6>Total Transactions</h6><h3 id="totalTransactions">0</h3></div>
        <div class="summary-card"><h6>Today Transactions</h6><h3 id="todayTransactions">0</h3></div>
        <div class="summary-card"><h6>Total Incentives</h6><h3 id="totalIncentives">₹0</h3></div>
        <div class="summary-card"><h6>Today Incentives</h6><h3 id="todayIncentives">₹0</h3></div>
        <div class="summary-card"><h6>Total Customers Added</h6><h3 id="totalCustomers">0</h3></div>
        <div class="summary-card"><h6>Today Customers Added</h6><h3 id="todayCustomers">0</h3></div>
    </div>

    <!-- FILTERS -->
    <div class="filter-bar">
        <input type="text" id="searchText" placeholder="Search Transaction / Customer">
        <input type="date" id="startDate">
        <input type="date" id="endDate">
        <select id="transactionType"></select>
        <button class="btn-primary" onclick="loadTransactions(1)">Search</button>
    </div>

    <!-- TABLE -->
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Transaction Id</th>
                    <th>Customer</th>
                    <th>Payment Type</th>
                    <th>Platform</th>
                    <th>Amount</th>
                    <th>Final Amount</th>
                    <th>Date & Time</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="transactionBody"></tbody>
        </table>
    </div>

    <div id="pagination"></div>
</div>

<!-- VIEW MODAL -->
<div class="modal-overlay" id="viewModal">
    <div class="modal-box">

        <!-- HEADER -->
        <div class="modal-header">
            <h4>Transaction Details</h4>
            <button class="close-btn" onclick="closeView()">✕</button>
        </div>

        <!-- BODY -->
        <div class="detail-grid" id="transactionDetails"></div>

        <!-- FOOTER -->
        <div class="modal-footer">
            <button class="btn-primary" onclick="closeView()">Close</button>
        </div>

    </div>
</div>





<script>
    const userId = @userId;
    const pageSize = 10;
        document.addEventListener('keydown', e => {
        if (e.key === "Escape") closeView();
    });
    /* SUMMARY */
    function loadSummary() {
        fetch('/Employee/GetUserTransaction?userId=' + userId)
        .then(r => r.json())
        .then(d => {
            totalTransactions.innerText = d.totalTransactions;
            todayTransactions.innerText = d.todayTransactions;
            totalIncentives.innerText = '₹' + d.totalIncentives;
            todayIncentives.innerText = '₹' + d.todayIncentives;
            totalCustomers.innerText = d.totalCustomersAdded;
            todayCustomers.innerText = d.todayCustomersAdded;
        });
    }

    /* TRANSACTION TYPES */
    fetch('/Employee/TranasactionTypes')
    .then(r => r.json())
    .then(d => {
        transactionType.innerHTML = `<option value="">All Types</option>`;
        d.forEach(x => transactionType.innerHTML +=
            `<option value="${x.id}">${x.name}</option>`);
    });

    /* LOAD TRANSACTIONS */
    function loadTransactions(pageNo) {

    const data = {
        TransactionId: 0,
        TransactionType: transactionType.value || "",
        SearchText: searchText.value || "",
        StartDate: startDate.value ? startDate.value + " 00:00:00" : "",
        EndDate: endDate.value ? endDate.value + " 23:59:59" : "",
        PageNo: pageNo,
        PageSize: pageSize,
        UserId: userId
    };

    fetch('/Employee/GetTransactions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(res => {

    transactionBody.innerHTML = '';

    if (!res.data.length) {
        transactionBody.innerHTML = `<tr><td colspan="7">No records found</td></tr>`;
        pagination.innerHTML = '';
        return;
    }
    debugger
    res.data.forEach(t => {
    transactionBody.innerHTML += `
    <tr>
    <td>${t.transactionId}</td>
    <td>${t.customerName}</td>
    <td>${t.incentiveName}</td>
    <td>${t.platformName}</td>
    <td>₹${t.transactionAmount}</td>
    <td>₹${t.finalAmount}</td>
    <td>${new Date(t.createdOn).toLocaleString()}</td>
    <td><button class="btn-primary" onclick="viewTransaction(${t.transactionId})">View</button></td>
    </tr>`;
    });

    renderPagination(res.totalCount, pageNo);
    });
    }

    function renderPagination(total, current) {
    const pages = Math.ceil(total / pageSize);
    let html = '';
    for (let i = 1; i <= pages; i++) {
    html += `<button class="${i === current ? 'active-page' : ''}"
    onclick="loadTransactions(${i})">${i}</button>`;
    }
    pagination.innerHTML = html;
    }

        function viewTransaction(id) {
        fetch('/Employee/GetTransactionById?transactionid=' + id)
            .then(r => r.json())
            .then(d => {

                if (!d) {
                    alert("No data found");
                    return;
                }

                transactionDetails.innerHTML = `
                <div class="detail-box">
                    <label>Transaction ID</label>
                    <input value="${d.transactionId}" readonly>
                </div>
                <div class="detail-box">
                    <label>Customer Name</label>
                    <input value="${d.customerName}" readonly>
                </div>
                <div class="detail-box">
                    <label>Platform Name</label>
                    <input value="${d.platformName}" readonly>
                </div>
                <div class="detail-box">
                    <label>Gateway Name</label>
                    <input value="${d.gatewayName}" readonly>
                </div>
                <div class="detail-box">
                    <label>Platform Charge(%)</label>
                    <input value="${d.gatewayCharge}" readonly>
                </div>
                <div class="detail-box">
                    <label>Transaction Type</label>
                    <input value="${d.incentiveName}" readonly>
                </div>
                <div class="detail-box">
                    <label>Credit Card Number</label>
                    <input value="${d.cardNumber}" readonly>
                </div>
                <div class="detail-box">
                    <label>Card Type</label>
                    <input value="${d.cardTypeName}" readonly>
                </div>
                <div class="detail-box">
                    <label>Card CVV</label>
                    <input value="${d.cardCVV}" readonly>
                </div>
                <div class="detail-box">
                    <label>Expiry Date</label>
                    <input value="${d.cardExpiryDate}" readonly>
                </div>
                <div class="detail-box">
                    <label>Transaction Amount</label>
                    <input value="${d.transactionAmount}" readonly>
                </div>
                <div class="detail-box">
                    <label>Platform Charge Amount</label>
                    <input value="${d.platformCharge}" readonly>
                </div>
                <div class="detail-box">
                    <label>Employee Charge Percent (%)</label>
                    <input value="${d.employeeChargePercent}" readonly>
                </div>
                <div class="detail-box">
                    <label>Employee Charge Amount</label>
                    <input value="${d.employeeChargeAmount}" readonly>
                </div>
                <div class="detail-box">
                    <label>Final Amount</label>
                    <input value="₹${d.finalAmount}" readonly>
                </div>
                <div class="detail-box">
                    <label>Bank Account Number</label>
                    <input value="${d.bankAccountNumber}" readonly>
                </div>
                <div class="detail-box">
                    <label>Bank IFSC</label>
                    <input value="${d.bankIFSC}" readonly>
                </div>
                <div class="detail-box">
                    <label>Remark</label>
                    <input value="${d.remark}" readonly>
                </div>
                `;

                viewModal.style.display = 'flex';
            });
    }

    function closeView() {
    viewModal.style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
    loadSummary();
    loadTransactions(1);
    });
</script>
