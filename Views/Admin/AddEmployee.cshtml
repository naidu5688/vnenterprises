@{
    Layout = "~/Views/Shared/_SharedLayout_Admin.cshtml";
}
@model vnenterprises.Models.EmployeeModel

<style>
    body {
        /* background-color: #2e7d5d; */
        font-family: 'Segoe UI', sans-serif;
        /* color: white; */
    }

    .page-container {
        max-width: 100%;
        background: #17362e; /* dark green */
        padding: 25px;
    }

    h3, h4 {
        color: #d4af37;
        margin-bottom: 18px;
        font-weight: 600;
    }

    label {
        font-size: 13px;
        font-weight: 500;
        color: white;
    }

    .form-control {
        height: 38px;
        border-radius: 6px;
        border: 1px solid #d4af37;
        background: #1e4a37;
        color: white;
        padding: 6px 10px;
        font-size: 13px;
        width: 100%;
    }

    input::placeholder {
        color: #ccc;
    }

    /* Slightly bigger checkboxes (~15px) */
    input[type="checkbox"] {
        transform: scale(1.2);
        cursor: pointer;
        margin-right: 5px;
    }

    /* Manager Details: 2-column layout */
    .manager-details {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 18px;
        margin-bottom: 20px;
    }

    .img-details {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 18px;
        margin-bottom: 20px;
    }
    /* Platform & Gateway cards */
    .card {
        border: 1px solid #d4af37;
        border-radius: 10px;
        margin-bottom: 12px;
        background: #1e4a37;
    }

    .card-header {
        padding: 10px 14px;
        font-weight: 600;
        color: white;
        border-bottom: 1px solid #d4af37;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .card-body {
        padding: 10px 12px;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
    }

    .form-check-label {
        color: white;
        font-size: 12px;
    }

    /* Bank & Branch allocation */
    .bank-box {
        border: 1px solid #d4af37;
        border-radius: 6px;
        padding: 8px 10px;
        display: flex;
        align-items: center;
        gap: 6px;
        color: white;
        font-size: 12px;
        background: #1e4a37;
    }

    /* Permissions */
    .permission-card {
        background: #1e4a37;
        border: 1px solid #d4af37;
        border-radius: 10px;
        padding: 12px;
        margin-top: 12px;
    }

    .permission-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        font-size: 12px;
    }

        .permission-row strong {
            color: #d4af37;
        }

    /* .btn-primary {
        background-color: #d4af37;
        color: #1e4a37;
        border-radius: 30px;
        padding: 10px 30px;
        border: 2px solid #1b5e20;
        font-weight: 600;
        cursor: pointer;
        margin-top: 12px;
    }

        .btn-primary:hover {
            background-color: #c29f2f;
        } */

    /* 2-column layout for Platforms/Banks/Branches */
    .two-column {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 18px;
        margin-bottom: 15px;
    }

    .three-column {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 18px;
        margin-bottom: 15px;
    }
    /* Permissions */
    .permission-card {
        background: #1e4a37;
        border: 1px solid #d4af37;
        border-radius: 10px;
        padding: 12px;
        margin-top: 12px;
    }

    .permission-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        font-size: 15px;
        color: white;
    }

        /* Align checkboxes to the left in each column */
        .permission-row input[type="checkbox"] {
            justify-self: start;
        }

        .permission-row strong {
            color: #d4af37;
        }

    .image-upload-box {
        display: flex;
        flex-direction: column;
        align-items: flex-start; /* align everything to left */
        margin-bottom: 15px;
    }

    .btn-upload {
        padding: 6px 12px;
        font-size: 13px;
        background: #d4af37;
        color: #1e4a37;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }

        .btn-upload:hover {
            background: #c29f2f;
        }

    /* .image-preview {
        max-height: 80px;
        border: 1px solid #d4af37;
        border-radius: 6px;
        display: block;
        margin-top: 6px;
    } */

    .delete-btn {
        padding: 4px 10px;
        font-size: 12px;
        background: #8d2525;
        color: #1e4a37;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: none; /* hidden until image is loaded */
        margin-top: 6px; /* ensures below image */
    }

        .delete-btn:hover {
            background: #c29f2f;
        }

    .file-name {
        color: white;
        font-size: 12px;
        margin-top: 4px;
    }

    .grid-4 {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 18px;
    }

    .image-upload-box {
        background: #1e4a37;
        border-radius: 10px;
        padding: 10px;
        text-align: center;
        height: 250px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 8px;
    }

    button {
        border-radius: 8px;
        padding: 7px 14px;
        font-size: 13px;
        border: none;
        cursor: pointer;
    }
    .image-preview {
        max-height: 150px;
        border-radius: 8px;
        display: none;
        cursor: zoom-in;
        width: 100%
    }

    .btn-primary {
        border-radius: 30px;
        background: #d4af37;
        color: #17362e;
        font-weight: 600;
        width: 100%;
    }

    .btn-danger {
        background: #8d2525;
        color: white;
        width: 100%;
        border-radius: 30px;
    }

    .form-footer {
        display: flex;
        justify-content: flex-end;
        margin-top: 25px;
    }

</style>

<div class="page-container">

    <h3>Add Employee</h3>

    <form id="employeeForm"
          asp-action="AddEmployee"
          asp-controller="Admin"
          method="post"
          enctype="multipart/form-data">

        <!-- MANAGER DETAILS (UNCHANGED) -->
        <div class="manager-details">
            <div>
                <label>First Name</label>
                <input asp-for="FirstName" class="form-control" required placeholder="Enter First Name"/>
            </div>
            <div>
                <label>Last Name</label>
                <input asp-for="LastName" class="form-control" required placeholder="Enter Last Name" />
            </div>
            <div>
                <label>Mobile Number</label>
                <input asp-for="MobileNumber" class="form-control"
                       maxlength="10"
                       oninput="this.value=this.value.replace(/[^0-9]/g,'')" required placeholder="Enter Mobile Number" />
            </div>
            <div>
                <label>MPIN</label>
                <input asp-for="MPIN" class="form-control"
                       maxlength="4"
                       oninput="this.value=this.value.replace(/[^0-9]/g,'')" required placeholder="Enter MPIN" />
            </div>
            <div>
                <label>Password</label>
                <input asp-for="Password" class="form-control" required placeholder="Enter Password" />
            </div>
            <div>
                <label>Confirm Password</label>
                <input asp-for="ConfirmPassword" class="form-control" required placeholder="Enter Confirm Password" />
            </div>
            <div>
                <label>Aadhar Number</label>
                <input asp-for="AadhaarNumber" class="form-control" required placeholder="Enter Aadhar Number" />
            </div>
            <div>
                <label>PAN Number</label>
                <input asp-for="PanNumber" class="form-control" required placeholder="Enter PAN Number" />
            </div>
        </div>
        <input type="hidden" asp-for="KycStatus" value="Pending" />

        <!-- DOCUMENT UPLOAD -->
        <h4>Documents</h4>

        <div class="grid-4">
            @foreach (var d in new[] {
                ("AadhaarFrontImage","Aadhaar Front *"),
                ("AadhaarBackImage","Aadhaar Back *"),
                ("PanFrontImage","PAN Front *"),
                ("PanBackImage","PAN Back (Optional)")
            })
            {
                <div class="image-upload-box" data-name="@d.Item1">

                    <input type="file"
                           name="@d.Item1"
                           accept="image/*"
                           hidden />

                    <img class="image-preview" />

                    <button type="button" class="btn-primary btn-upload">Upload</button>
                    <button type="button" class="btn-danger btn-delete">Delete</button>

                    <span style="color:#d4af37;text-align:center;display:block">
                        @d.Item2
                    </span>
                </div>
            }
        </div>

        <!-- PLATFORMS & GATEWAYS -->
        <h4>Platform & Gateway Allocation</h4>

        <div class="two-column">
            @if(Model.PlatformGatewayModel.Platforms != null)
            {
                @foreach (var platform in Model.PlatformGatewayModel.Platforms)
                {
                    <div class="card">
                        <div class="card-header platform-header">
                            <input type="checkbox"
                                   class="platform-checkbox"
                                   data-platform="@platform.Name"
                                   name="SelectedPlatform"
                                   value="@platform.Id" />

                            <span>@platform.Name</span>
                        </div>

                        @if(Model.PlatformGatewayModel.Gateways != null)
                        {
                            <div class="card-body">
                                @foreach (var gateway in Model.PlatformGatewayModel.Gateways
                                                    .Where(g => g.PlatformName == platform.Name))
                                {
                                    <div class="form-check">
                                        <input type="checkbox"
                                               class="gateway-checkbox"
                                               data-platform="@platform.Name"
                                               name="SelectedGateways"
                                               value="@gateway.Id" />
                                        <label class="form-check-label">@gateway.Name</label>
                                    </div>
                                }
                            </div>
                        }
                        
                    </div>
                }
            }
            
        </div>

        <!-- BRANCH -->
        <h4>Branch Allocation</h4>
        <div class="three-column">
            @if(Model.branchmodel != null)
            {
                @foreach (var branch in Model.branchmodel)
                {
                    <div class="bank-box">
                        <input type="checkbox"
                               class="branch-checkbox"
                               name="SelectedBranches"
                               value="@branch.BranchId" />
                        @branch.BranchName
                    </div>
                }
            }
            
        </div>

        <div class="form-footer">
            <button type="button" class="btn-primary" onclick="submitEmployee()" style="width: 20%;">
                Add Employee
            </button>
        </div>


    </form>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function () {

        /* IMAGE UPLOAD */
        document.querySelectorAll('.image-upload-box').forEach(box => {

            const input = box.querySelector('input[type="file"]');
            const uploadBtn = box.querySelector('.btn-upload');
            const deleteBtn = box.querySelector('.btn-delete');
            const img = box.querySelector('.image-preview');

            uploadBtn.onclick = () => input.click();

            input.onchange = () => {
                if (!input.files.length) return;
                img.src = URL.createObjectURL(input.files[0]);
                img.style.display = 'block';
                deleteBtn.style.display = 'block';
            };

            deleteBtn.onclick = () => {
                input.value = '';
                img.src = '';
                img.style.display = 'none';
                deleteBtn.style.display = 'block';
            };
        });

        /* PLATFORM → GATEWAY SELECT ALL */
        document.querySelectorAll('.platform-checkbox').forEach(p => {
            p.addEventListener('change', function () {
                document
                    .querySelectorAll(`.gateway-checkbox[data-platform="${this.dataset.platform}"]`)
                    .forEach(g => g.checked = this.checked);
            });
        });

        /* GATEWAY → PLATFORM AUTO CHECK */
        document.querySelectorAll('.gateway-checkbox').forEach(g => {
            g.addEventListener('change', function () {
                const platform = document.querySelector(
                    `.platform-checkbox[data-platform="${this.dataset.platform}"]`
                );

                const gateways = document.querySelectorAll(
                    `.gateway-checkbox[data-platform="${this.dataset.platform}"]`
                );

                platform.checked = [...gateways].every(x => x.checked);
            });
        });

        /* SINGLE BRANCH */
        document.querySelectorAll('.branch-checkbox').forEach(b => {
            b.addEventListener('change', function () {
                if (this.checked) {
                    document.querySelectorAll('.branch-checkbox')
                        .forEach(x => x !== this && (x.checked = false));
                }
            });
        });

    });

    /* JS SUBMIT */
    function submitEmployee() {

        if (!validateForm()) return;

        const form = document.getElementById('employeeForm');
        const data = new FormData(form);
        debugger
        fetch(form.action, {
            method: 'POST',
            body: data
        })
        .then(response => response.json())
        .then(result => {

        if (result.success) {
            alert(result.message);
            window.location.href = "/Admin/Employee";
        } else {
            alert(result.message);
        }

    })
    .catch(() => alert("Error saving employee"));
    }

        function validateForm() {

        const password = document.querySelector('[name="Password"]').value.trim();
        const confirm = document.querySelector('[name="ConfirmPassword"]').value.trim();
        const firstname = document.querySelector('[name="FirstName"]').value.trim();
        const lastname = document.querySelector('[name="LastName"]').value.trim();
        const mobilenumber = document.querySelector('[name="MobileNumber"]').value.trim();
        const mpin = document.querySelector('[name="MPIN"]').value.trim();
        const aadhar = document.querySelector('[name="AadhaarNumber"]').value.trim();
        const pan = document.querySelector('[name="PanNumber"]').value.trim();

        /* REQUIRED TEXT FIELDS */
        if (
            firstname === "" ||
            lastname === "" ||
            mobilenumber === "" ||
            mpin === "" ||
            password === "" ||
            confirm === "" ||
            aadhar === "" ||
            pan === ""
        ) {
            alert("Please enter all mandatory details");
            return false;
        }

        /* PASSWORD MATCH */
        if (password !== confirm) {
            alert("Passwords do not match");
            return false;
        }

        /* REQUIRED IMAGES (PAN BACK OPTIONAL) */
        const requiredImages = [
            { name: "AadhaarFrontImage", label: "Aadhaar Front Image" },
            { name: "AadhaarBackImage", label: "Aadhaar Back Image" },
            { name: "PanFrontImage", label: "PAN Front Image" }
        ];

        for (let img of requiredImages) {
            const input = document.querySelector(`input[name="${img.name}"]`);
            if (!input || input.files.length === 0) {
                alert(`Please upload ${img.label}`);
                return false;
            }
        }

        /* GATEWAY CHECK */
        if (!document.querySelector('input[name="SelectedGateways"]:checked')) {
            alert("Select at least one Gateway");
            return false;
        }

        /* BRANCH CHECK */
        if (!document.querySelector('.branch-checkbox:checked')) {
            alert("Select one Branch");
            return false;
        }

        return true;
    }


</script>



