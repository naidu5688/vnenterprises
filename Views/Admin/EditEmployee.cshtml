@{
    Layout = "~/Views/Shared/_SharedLayout_Admin.cshtml";
    var kycStatus = Model?.KycStatus ?? "Pending";
}
@model vnenterprises.Models.EmployeeModel

<style>
    body {
        /* background-color: #2e7d5d; */
        font-family: 'Segoe UI', sans-serif;
        /* color: white; */
    }

    .page-container {
        max-width: 100%;
        background: #17362e; /* dark green */
        padding: 25px;
    }

    h3, h4 {
        color: #d4af37;
        margin-bottom: 18px;
        font-weight: 600;
    }

    label {
        font-size: 13px;
        font-weight: 500;
        color: white;
    }

    .form-control {
        height: 38px;
        border-radius: 6px;
        border: 1px solid #d4af37;
        background: #1e4a37;
        color: white;
        padding: 6px 10px;
        font-size: 13px;
        width: 100%;
    }

    input::placeholder {
        color: #ccc;
    }

    /* Slightly bigger checkboxes (~15px) */
    input[type="checkbox"] {
        transform: scale(1.2);
        cursor: pointer;
        margin-right: 5px;
    }

    /* Manager Details: 2-column layout */
    .manager-details {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 18px;
        margin-bottom: 20px;
    }

    .img-details {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 18px;
        margin-bottom: 20px;
    }
    /* Platform & Gateway cards */
    .card {
        border: 1px solid #d4af37;
        border-radius: 10px;
        margin-bottom: 12px;
        background: #1e4a37;
    }

    .card-header {
        padding: 10px 14px;
        font-weight: 600;
        color: white;
        border-bottom: 1px solid #d4af37;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .card-body {
        padding: 10px 12px;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
    }

    .form-check-label {
        color: white;
        font-size: 12px;
    }

    /* Bank & Branch allocation */
    .bank-box {
        border: 1px solid #d4af37;
        border-radius: 6px;
        padding: 8px 10px;
        display: flex;
        align-items: center;
        gap: 6px;
        color: white;
        font-size: 12px;
        background: #1e4a37;
    }

    /* Permissions */
    .permission-card {
        background: #1e4a37;
        border: 1px solid #d4af37;
        border-radius: 10px;
        padding: 12px;
        margin-top: 12px;
    }

    .permission-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        font-size: 12px;
    }

        .permission-row strong {
            color: #d4af37;
        }

    /* .btn-primary {
            background-color: #d4af37;
            color: #1e4a37;
            border-radius: 30px;
            padding: 10px 30px;
            border: 2px solid #1b5e20;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }

            .btn-primary:hover {
                background-color: #c29f2f;
            } */

    /* 2-column layout for Platforms/Banks/Branches */
    .two-column {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 18px;
        margin-bottom: 15px;
    }

    .three-column {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 18px;
        margin-bottom: 15px;
    }
    /* Permissions */
    .permission-card {
        background: #1e4a37;
        border: 1px solid #d4af37;
        border-radius: 10px;
        padding: 12px;
        margin-top: 12px;
    }

    .permission-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        font-size: 15px;
        color: white;
    }

        /* Align checkboxes to the left in each column */
        .permission-row input[type="checkbox"] {
            justify-self: start;
        }

        .permission-row strong {
            color: #d4af37;
        }



    .btn-upload {
        padding: 6px 12px;
        font-size: 13px;
        background: #d4af37;
        color: #1e4a37;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }

        .btn-upload:hover {
            background: #c29f2f;
        }

    /* .image-preview {
            max-height: 80px;
            border: 1px solid #d4af37;
            border-radius: 6px;
            display: block;
            margin-top: 6px;
        } */

    .delete-btn {
        padding: 4px 10px;
        font-size: 12px;
        background: #8d2525;
        color: #fff;
        border: none;
        width: 100%;
        border-radius: 30px;
        cursor: pointer;
        display: none; /* hidden until image is loaded */
        margin-top: 6px;
    }

        .delete-btn:hover {
            background: #c29f2f;
        }


    .file-name {
        color: white;
        font-size: 12px;
        margin-top: 4px;
    }

    .grid-4 {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 18px;
    }

    .image-upload-box {
        background: #1e4a37;
        border-radius: 10px;
        padding: 10px;
        text-align: center;
        height: 250px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 8px;
    }

    button {
        border-radius: 8px;
        padding: 7px 14px;
        font-size: 13px;
        border: none;
        cursor: pointer;
    }

    .image-preview {
        max-height: 150px;
        border-radius: 8px;
        display: none;
        cursor: zoom-in;
        width: 100%
    }

    .btn-primary {
        border-radius: 30px;
        background: #d4af37;
        color: #17362e;
        font-weight: 600;
        width: 100%;
    }

    .btn-danger {
        background: #8d2525;
        color: white;
        width: 100%;
        border-radius: 30px;
    }

    .form-footer {
        display: flex;
        justify-content: flex-end;
        margin-top: 25px;
    }

    .kyc-select {
        padding: 6px 15px;
        border-radius: 20px;
        border: none;
        font-weight: 600;
        cursor: pointer;
    }
    /* Status colors */
    .kyc-pending {
        background: #f1c40f;
        color: #17362e;
    }

    .pending {
        background: #f1c40f;
        color: #17362e;
    }

    .approved {
        background: #2ecc71;
        color: #17362e;
    }

    .rejected {
        background: #e74c3c;
        color: #17362e;
    }

    .kyc-approved {
        background: #2ecc71;
        color: #17362e;
    }

    .kyc-rejected {
        background: #e74c3c;
        color: white;
    }

    .top-right-bar {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
    }

    .customer-id {
        font-weight: 600;
        color: #d4af37;
    }

    .kyc-wrapper {
        position: relative;
    }

    .kyc-badge {
        padding: 8px 15px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Dropdown menu */
    .kyc-menu {
        display: none;
        position: absolute;
        top: 45px;
        right: 0;
        background: #1e4a37;
        border-radius: 10px;
        min-width: 140px;
        box-shadow: 0 6px 14px rgba(0,0,0,.35);
        z-index: 100;
    }

        .kyc-menu div {
            padding: 10px 14px;
            cursor: pointer;
            font-weight: 600;
        }

            .kyc-menu div:hover {
                background: rgba(255,255,255,.1);
            }

    #firstName, #lastName {
        text-transform: uppercase;
    }
</style>

<div class="page-container">

    <h3>Edit Employee</h3>


    <div class="top-right-bar">

        <div class="customer-id">
            Employee ID: @Model.EmployeeId;
        </div>

        <!-- KYC DROPDOWN -->
        <div class="kyc-wrapper">
            <div id="kycstatus"
                 class="kyc-badge @(kycStatus.ToLower() == "pending" ? "kyc-pending" : kycStatus.ToLower() == "approved" ? "kyc-approved" : "kyc-rejected")"
                 onclick="toggleKycMenu()">
                KYC: <span id="kycText">@kycStatus</span>
                <i class="fa-solid fa-chevron-down"></i>
            </div>

            <div id="kycMenu" class="kyc-menu">
                <div onclick="selectKycStatus('Pending')" class="pending">Pending</div>
                <div onclick="selectKycStatus('Approved')" class="approved">Approved</div>
                <div onclick="selectKycStatus('Rejected')" class="rejected">Rejected</div>
            </div>
        </div>

    </div>



    <!-- ✅ THIS WILL GO TO CONTROLLER ON SAVE -->
    <form id="employeeForm"
          asp-action="EditEmployee"
          asp-controller="Admin"
          method="post"
          enctype="multipart/form-data">

        <input type="hidden" asp-for="EmployeeId" />
        <input type="hidden" asp-for="KycStatus" id="kycHidden" />

        <!-- BASIC DETAILS -->
        <div class="manager-details">
            <div>
                <label>First Name</label>
                <input asp-for="FirstName" id="firstName" class="form-control" />
            </div>
            <div>
                <label>Last Name</label>
                <input asp-for="LastName" id="lastName" class="form-control" />
            </div>
            <div>
                <label>Mobile</label>
                <input asp-for="MobileNumber" class="form-control" />
            </div>
            <div>
                <label>MPIN</label>
                <input asp-for="MPIN" class="form-control" />
            </div>
            <div>
                <label>Password</label>
                <input asp-for="Password" class="form-control" />
            </div>
            <div>
                <label>Confirm Password</label>
                <input asp-for="ConfirmPassword" class="form-control" />
            </div>
            <div>
                <label>Aadhaar</label>
                <input asp-for="AadhaarNumber" class="form-control" />
            </div>
            <div>
                <label>PAN</label>
                <input asp-for="PanNumber" class="form-control" />
            </div>
        </div>
        <input type="hidden" name="aadharfrontpath" value="@Model?.aadharfrontpath" />
        <input type="hidden" name="aadharbackpath" value="@Model?.aadharbackpath" />
        <input type="hidden" name="panfrontpath" value="@Model?.panfrontpath" />
        <input type="hidden" name="panbackpath" value="@Model?.panbackpath" />


        <h4>Documents</h4>
        <div class="grid-4">
            @foreach (var d in new[] {
                        ("AadhaarFrontImage", "Aadhaar Front *", Model?.aadharfrontpath),
                        ("AadhaarBackImage",  "Aadhaar Back *",  Model?.aadharbackpath),
                        ("PanFrontImage",     "PAN Front *",     Model?.panfrontpath),
                        ("PanBackImage",      "PAN Back (Optional)", Model?.panbackpath)
                        })
            {
                <div class="image-upload-box" data-name="@d.Item1">
                    <img class="image-preview"
                         src="@d.Item3"
                         style="display:@(string.IsNullOrEmpty(d.Item3) ? "none" : "block")">

                    <input type="file"
                           id="@d.Item1"
                           name="@d.Item1"
                           accept="image/*"
                           style="display:none">

                    <button type="button"
                            class="btn-primary"
                            onclick="document.getElementById('@d.Item1').click()">
                        Upload
                    </button>

                    <button type="button"
                            class="btn-danger"
                            onclick="deleteImage('@d.Item1')">
                        Delete
                    </button>

                    <span style="color:#d4af37">@d.Item2</span>
                </div>
            }
        </div>


        <!-- PLATFORM & GATEWAY -->
        <h4>Platform & Gateway Allocation</h4>

        <div class="two-column">
            @if (Model.PlatformGatewayModel.Platforms != null)
            {
                @foreach (var platform in Model.PlatformGatewayModel.Platforms)
                {
                    <div class="card">
                        <div class="card-header platform-header">
                            <input type="checkbox"
                                   class="platform-checkbox"
                                   data-platform="@platform.Name"
                                   name="SelectedPlatform"
                                   value="@platform.Id" />

                            <span>@platform.Name</span>
                        </div>

                        @if (Model.PlatformGatewayModel.Gateways != null)
                        {
                            <div class="card-body">
                                @foreach (var gateway in Model.PlatformGatewayModel.Gateways
                                                    .Where(g => g.PlatformName == platform.Name))
                                {
                                    <div class="form-check">
                                        <input type="checkbox"
                                               class="gateway-checkbox"
                                               data-platform="@platform.Name"
                                               name="SelectedGateways"
                                               value="@gateway.Id"
                                               @(Model.SelectedGateways != null && Model.SelectedGateways.Contains(gateway.Id) ? "checked" : "") />

                                        <label class="form-check-label">@gateway.Name</label>
                                    </div>
                                }
                            </div>
                        }

                    </div>
                }
            }

        </div>

        <!-- BRANCH -->
        <h4>Branch Allocation</h4>

        <div class="three-column">
            @foreach (var branch in Model.branchmodel)
            {
                <div class="bank-box">
                    <input type="checkbox"
                           class="branch-checkbox"
                           name="SelectedBranches"
                           value="@branch.BranchId"
                           @(Model.SelectedBranches.Contains(branch.BranchId) ? "checked" : "") />
                    @branch.BranchName
                </div>
            }
        </div>

        <div class="form-footer">
            <button type="button"
                    class="btn-primary"
                    onclick="submitEmployee()"
                    style="width:20%;">
                Update Employee
            </button>
        </div>

    </form>
</div>



<script>
    document.addEventListener('DOMContentLoaded', function () {

        /* IMAGE UPLOAD */
            document.querySelectorAll('.image-upload-box').forEach(box => {

        const input = box.querySelector('input[type="file"]');
        const uploadBtn = box.querySelector('.btn-upload');
        const deleteBtn = box.querySelector('.delete-btn');
        const img = box.querySelector('.image-preview');

        // Upload button opens file selector
        uploadBtn.onclick = () => input.click();

        // On file select
        input.onchange = () => {
            if (!input.files.length) return;
            img.src = URL.createObjectURL(input.files[0]);
            img.style.display = 'block';
            deleteBtn.style.display = 'block';
        };

        // Delete button clears the image
        deleteBtn.onclick = () => {
            input.value = '';         // Clear file input
            img.src = '';             // Clear preview
            img.style.display = 'none';
            deleteBtn.style.display = 'none';
        };

        // Show delete button if image exists on page load
        if (img.src && img.style.display === 'block') {
            deleteBtn.style.display = 'block';
        }
    });

    });

        // 🔥 TRACK DELETED IMAGES
    let deletedImages = {
        AadhaarFrontImage: false,
        AadhaarBackImage: false,
        PanFrontImage: false,
        PanBackImage: false
    };

    // 🔥 OLD IMAGE PATHS FROM MODEL
    const oldImages = {
        AadhaarFrontImage: "@Model?.aadharfrontpath",
        AadhaarBackImage: "@Model?.aadharbackpath",
        PanFrontImage: "@Model?.panfrontpath",
        PanBackImage: "@Model?.panbackpath"
    };

    // CHECK IF NEW FILE SELECTED
    function hasNewFile(id) {
        const el = document.getElementById(id);
        return el && el.files && el.files.length > 0;
    }

    // DELETE IMAGE
    function deleteImage(id) {

        const input = document.getElementById(id);
        const box = input.closest('.image-upload-box');
        const img = box.querySelector('.image-preview');

        input.value = "";
        img.src = "";
        img.style.display = "none";

        deletedImages[id] = true;
    }

    // AUTO PREVIEW WHEN FILE SELECTED
    document.querySelectorAll('input[type="file"]').forEach(input => {

        input.addEventListener('change', function () {

            if (!this.files.length) return;

            const box = this.closest('.image-upload-box');
            const img = box.querySelector('.image-preview');

            img.src = URL.createObjectURL(this.files[0]);
            img.style.display = "block";

            deletedImages[this.id] = false; // reset delete flag
        });

    });


            document.addEventListener('DOMContentLoaded', function () {

        /* AUTO SELECT PLATFORM IF ALL GATEWAYS CHECKED */
        document.querySelectorAll('.platform-checkbox').forEach(platform => {

            const platformName = platform.dataset.platform;

            const gateways = document.querySelectorAll(
                `.gateway-checkbox[data-platform="${platformName}"]`
            );

            if (gateways.length > 0) {

                const checkedCount = [...gateways].filter(g => g.checked).length;

                platform.checked = (checkedCount === gateways.length);
            }
        });

        /* PLATFORM → SELECT ALL GATEWAYS */
        document.querySelectorAll('.platform-checkbox').forEach(p => {
            p.addEventListener('change', function () {

                const gateways = document.querySelectorAll(
                    `.gateway-checkbox[data-platform="${this.dataset.platform}"]`
                );

                gateways.forEach(g => g.checked = this.checked);
            });
        });

        /* GATEWAY → UPDATE PLATFORM */
        document.querySelectorAll('.gateway-checkbox').forEach(g => {
            g.addEventListener('change', function () {

                const platform = document.querySelector(
                    `.platform-checkbox[data-platform="${this.dataset.platform}"]`
                );

                const gateways = document.querySelectorAll(
                    `.gateway-checkbox[data-platform="${this.dataset.platform}"]`
                );

                const checkedCount = [...gateways].filter(x => x.checked).length;

                platform.checked = (checkedCount === gateways.length);
            });
        });

    });


        /* SINGLE BRANCH */
        document.querySelectorAll('.branch-checkbox').forEach(b => {
            b.addEventListener('change', function () {
                if (this.checked) {
                    document.querySelectorAll('.branch-checkbox')
                        .forEach(x => x !== this && (x.checked = false));
                }
            });
        });
        /* JS SUBMIT */function submitEmployee() {

        if (!validateForm()) return;

        const form = document.getElementById('employeeForm');
        const data = new FormData(form);

        // 🔥 Send deleted images info to controller
        data.append("DeletedImages", JSON.stringify(deletedImages));

        fetch(form.action, {
            method: 'POST',
            body: data
        })
        .then(response => response.json())
        .then(result => {

            if (result.success) {
                alert(result.message);
                window.location.href = "/Admin/Employee";
            } else {
                alert(result.message);
            }

        })
        .catch(() => alert("Error saving employee"));
    }


    // ===============================
    // VALIDATION FUNCTION
    // ===============================

    function validateForm() {

        const password = document.querySelector('[name="Password"]').value.trim();
        const confirm = document.querySelector('[name="ConfirmPassword"]').value.trim();
        let firstname = document.querySelector('[name="FirstName"]').value.trim();
        let lastname = document.querySelector('[name="LastName"]').value.trim();
        const mobilenumber = document.querySelector('[name="MobileNumber"]').value.trim();
        const mpin = document.querySelector('[name="MPIN"]').value.trim();
        const aadhar = document.querySelector('[name="AadhaarNumber"]').value.trim();
        const pan = document.querySelector('[name="PanNumber"]').value.trim();
        firstname = firstname.toUpperCase();
        lastname = lastname.toUpperCase();

        document.querySelector('[name="FirstName"]').value = firstname;
        document.querySelector('[name="LastName"]').value = lastname;
        // ✅ REQUIRED TEXT FIELDS
        if (
            firstname === "" ||
            lastname === "" ||
            mobilenumber === "" ||
            mpin === "" ||
            password === "" ||
            confirm === "" ||
            aadhar === "" ||
            pan === ""
        ) {
            alert("Please enter all mandatory details");
            return false;
        }

        // ✅ PASSWORD MATCH
        if (password !== confirm) {
            alert("Passwords do not match");
            return false;
        }

        // ✅ REQUIRED IMAGES (EDIT SAFE)
        if (
            (!hasNewFile("AadhaarFrontImage") && (!oldImages.AadhaarFrontImage || deletedImages.AadhaarFrontImage)) ||
            (!hasNewFile("AadhaarBackImage")  && (!oldImages.AadhaarBackImage  || deletedImages.AadhaarBackImage)) ||
            (!hasNewFile("PanFrontImage")     && (!oldImages.PanFrontImage     || deletedImages.PanFrontImage))
        ) {
            alert("Aadhaar Front, Aadhaar Back & PAN Front images are mandatory");
            return false;
        }

        // ✅ GATEWAY CHECK
        if (!document.querySelector('input[name="SelectedGateways"]:checked')) {
            alert("Select at least one Gateway");
            return false;
        }

        // ✅ BRANCH CHECK
        if (!document.querySelector('.branch-checkbox:checked')) {
            alert("Select one Branch");
            return false;
        }

        return true;
    }

        function toggleKycMenu() {
        const menu = document.getElementById("kycMenu");
        menu.style.display = menu.style.display === "block" ? "none" : "block";
    }

    function selectKycStatus(status) {

        const badge = document.getElementById("kycstatus");
        const text = document.getElementById("kycText");
        const hidden = document.getElementById("kycHidden");

        text.innerText = status;
        hidden.value = status;

        badge.classList.remove("kyc-pending", "kyc-approved", "kyc-rejected");

        if (status.toLowerCase() === "pending")
            badge.classList.add("kyc-pending");

        if (status.toLowerCase() === "approved")
            badge.classList.add("kyc-approved");

        if (status.toLowerCase() === "rejected")
            badge.classList.add("kyc-rejected");

        document.getElementById("kycMenu").style.display = "none";
    }



</script>



