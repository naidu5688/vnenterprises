@{
    Layout = "~/Views/Shared/_SharedLayout_Admin.cshtml";
    var kycStatus = Model?.KycStatus ?? "Pending";
}
@model vnenterprises.Models.ManagerModel

<style>
    body {
        font-family: 'Segoe UI', sans-serif;
    }

    .page-container {
        max-width: 100%;
        background: #17362e;
        padding: 25px;
    }

    h3, h4 {
        color: #d4af37;
        margin-bottom: 18px;
        font-weight: 600;
    }

    label {
        font-size: 13px;
        font-weight: 500;
        color: white;
    }

    .form-control {
        height: 38px;
        border-radius: 6px;
        border: 1px solid #d4af37;
        background: #1e4a37;
        color: white;
        padding: 6px 10px;
        font-size: 13px;
        width: 100%;
    }

    input::placeholder {
        color: #ccc;
    }

    input[type="checkbox"] {
        transform: scale(1.2);
        cursor: pointer;
        margin-right: 5px;
    }

    .manager-details {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 18px;
        margin-bottom: 20px;
    }

    .bank-box {
        border: 1px solid #d4af37;
        border-radius: 6px;
        padding: 8px 10px;
        display: flex;
        align-items: center;
        gap: 6px;
        color: white;
        font-size: 12px;
        background: #1e4a37;
    }

    .permission-card {
        background: #1e4a37;
        border: 1px solid #d4af37;
        border-radius: 10px;
        padding: 12px;
        margin-top: 12px;
    }

    .permission-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        font-size: 15px;
        color: white;
    }

    .permission-row input[type="checkbox"] {
        justify-self: start;
    }

    .permission-row strong {
        color: #d4af37;
    }

    .three-column {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 18px;
        margin-bottom: 15px;
    }

    .btn-primary {
        background-color: #d4af37;
        color: #1e4a37;
        border-radius: 30px;
        padding: 10px 30px;
        border: 2px solid #1b5e20;
        font-weight: 600;
        cursor: pointer;
        margin-top: 12px;
    }

    .btn-primary:hover {
        background-color: #c29f2f;
    }

    .top-right-bar {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
    }

    .customer-id {
        font-weight: 600;
        color: #d4af37;
    }

    .kyc-select {
        padding: 6px 15px;
        border-radius: 20px;
        border: none;
        font-weight: 600;
        cursor: pointer;
    }
    /* Status colors */
    .kyc-pending {
        background: #f1c40f;
        color: #17362e;
    }

    .pending {
        background: #f1c40f;
        color: #17362e;
    }

    .approved {
        background: #2ecc71;
        color: #17362e;
    }

    .rejected {
        background: #e74c3c;
        color: #17362e;
    }

    .kyc-approved {
        background: #2ecc71;
        color: #17362e;
    }

    .kyc-rejected {
        background: #e74c3c;
        color: white;
    }

    .top-right-bar {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
    }

    .customer-id {
        font-weight: 600;
        color: #d4af37;
    }

    .kyc-wrapper {
        position: relative;
    }

    .kyc-badge {
        padding: 8px 15px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Dropdown menu */
    .kyc-menu {
        display: none;
        position: absolute;
        top: 45px;
        right: 0;
        background: #1e4a37;
        border-radius: 10px;
        min-width: 140px;
        box-shadow: 0 6px 14px rgba(0,0,0,.35);
        z-index: 100;
    }

        .kyc-menu div {
            padding: 10px 14px;
            cursor: pointer;
            font-weight: 600;
        }

            .kyc-menu div:hover {
                background: rgba(255,255,255,.1);
            }

    .uppercase {
        text-transform: uppercase;
    }

</style>

<div class="page-container">

    <div class="top-right-bar">

        <div class="customer-id">
            Manager ID: @Model.ManagerId
        </div>

        <div class="kyc-wrapper">
            <div id="kycstatus"
                 class="kyc-badge @(kycStatus.ToLower() == "pending" ? "kyc-pending" : kycStatus.ToLower() == "approved" ? "kyc-approved" : "kyc-rejected")"
                 onclick="toggleKycMenu()">
                KYC: <span id="kycText">@kycStatus</span>
                <i class="fa-solid fa-chevron-down"></i>
            </div>

            <div id="kycMenu" class="kyc-menu">
                <div onclick="selectKycStatus('Pending')" class="pending">Pending</div>
                <div onclick="selectKycStatus('Approved')" class="approved">Approved</div>
                <div onclick="selectKycStatus('Rejected')" class="rejected">Rejected</div>
            </div>
        </div>

    </div>

    <form id="managerForm" asp-action="EditManager" asp-controller="Admin" method="post" onsubmit="return validateForm()">
        <input type="hidden" asp-for="ManagerId" />
        <input type="hidden" asp-for="KycStatus" id="kycHidden" />
        <!-- Manager Details -->
        <div class="manager-details">
            <div>
                <label>First Name</label>
                <input asp-for="UserFirstName" class="form-control uppercase" placeholder="First Name" required value="@Model.UserFirstName" />
            </div>
            <div>
                <label>Last Name</label>
                <input asp-for="UserLastName" class="form-control uppercase" placeholder="Last Name" required value="@Model.UserLastName" />
            </div>
            <div>
                <label>Mobile Number</label>
                <input asp-for="MobileNumber" class="form-control" type="text" placeholder="10 Digit Mobile Number" maxlength="10" 
                       oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,10)" 
                       required value="@Model.MobileNumber" readonly/>
            </div>
            <div>
                <label>MPIN</label>
                <input asp-for="MPIN" type="text" class="form-control" placeholder="4 Digit MPIN" maxlength="4"
                       oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,4)"
                       required value="@Model.MPIN" />
            </div>
            <div>
                <label>Password</label>
                <input asp-for="Password" type="text" class="form-control" placeholder="Password" required value="@Model.Password" />
            </div>
            <div>
                <label>Confirm Password</label>
                <input asp-for="ConfirmPassword" type="text" class="form-control" placeholder="Confirm Password" required value="@Model.ConfirmPassword" />
            </div>
        </div>

        <h4>Branch Allocation</h4>
        <div class="three-column">
            @foreach (var branch in Model.branchmodel)
            {
                <div class="bank-box">
                    <input type="checkbox" name="SelectedBranches" value="@branch.BranchId" 
                           @(Model.SelectedBranches.Contains(branch.BranchId) ? "checked" : "") />
                    @branch.BranchName
                </div>
            }
        </div>

        <!-- Permissions -->
        <h4>Access Permissions</h4>
        <div class="permission-card">
            <div class="permission-row">
                <strong>Module</strong>
                <strong>View</strong>
                <strong>Add</strong>
                <strong>Edit</strong>
            </div>
            <div class="permission-row">
            <span>Employee</span>
            <input type="checkbox" asp-for="IsEmployeeViewAccess" />
            <input type="checkbox" asp-for="IsEmployeeAddAccess" />
            <input type="checkbox" asp-for="IsEmployeeEditAccess" />
        </div>

        <div class="permission-row">
            <span>Retailer</span>
            <input type="checkbox" asp-for="IsRetailerViewAccess" />
            <input type="checkbox" asp-for="IsRetailerAddAccess"/>
            <input type="checkbox" asp-for="IsRetailerEditAccess"/>
        </div>

        <div class="permission-row">
            <span>KYC</span>
            <input type="checkbox" asp-for="IsKycViewAccess"  />
            <input type="checkbox" asp-for="IsKycAddAccess"  />
            <input type="checkbox" asp-for="IsKycEditAccess"/>
        </div>
        </div>

        <div class="text-end">
            <button type="submit" class="btn-primary">Update Manager</button>
        </div>

    </form>

</div>

<script>
    // Uppercase first & last name
    let firstNameInput = document.querySelector('[name="UserFirstName"]');
    let lastNameInput = document.querySelector('[name="UserLastName"]');
    firstNameInput = firstNameInput.toUpperCase();
    lastNameInput = lastNameInput.toUpperCase();

    document.querySelector('[name="UserFirstName"]').value = firstNameInput;
    document.querySelector('[name="UserLastName"]').value = lastNameInput;
    firstNameInput.addEventListener('input', () => firstNameInput.value = firstNameInput.value.toUpperCase().trimStart());
    lastNameInput.addEventListener('input', () => lastNameInput.value = lastNameInput.value.toUpperCase().trimStart());

    // Remove spaces in passwords
    const passwordInput = document.querySelector('[name="Password"]');
    const confirmPasswordInput = document.querySelector('[name="ConfirmPassword"]');
    passwordInput.addEventListener('input', () => passwordInput.value = passwordInput.value.replace(/\s/g, ''));
    confirmPasswordInput.addEventListener('input', () => confirmPasswordInput.value = confirmPasswordInput.value.replace(/\s/g, ''));

    // Form validation
    function validateForm() {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        const mobile = document.querySelector('[name="MobileNumber"]').value;
        const mpin = document.querySelector('[name="MPIN"]').value;
        const selectedBranches = document.querySelectorAll('input[name="SelectedBranches"]:checked');

        if (password !== confirmPassword) { alert("Password and Confirm Password must match."); return false; }
        if (mobile.length !== 10) { alert("Mobile number must be exactly 10 digits."); return false; }
        if (mpin.length !== 4) { alert("MPIN must be exactly 4 digits."); return false; }
        if (selectedBranches.length === 0) { alert("Please select at least one Branch."); return false; }

        return true;
    }

    // Custom submit
    document.getElementById('managerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        if (!validateForm()) return;

        const form = e.target;
        const data = new FormData(form);

        fetch(form.action, { method: 'POST', body: data })
        .then(res => res.json())
        .then(result => {
            if (result.success) { alert(result.message); window.location.href = "/Admin/Manager"; }
            else { alert(result.message); }
        })
        .catch(() => alert("Error saving Manager"));
    });

    // KYC dropdown
    function toggleKycMenu() {
            const menu = document.getElementById("kycMenu");
            menu.style.display = menu.style.display === "block" ? "none" : "block";
        }
        function selectKycStatus(status) {

        const badge = document.getElementById("kycstatus");
        const text = document.getElementById("kycText");
        const hidden = document.getElementById("kycHidden");

        text.innerText = status;
        hidden.value = status;

        badge.classList.remove("kyc-pending", "kyc-approved", "kyc-rejected");

        if (status.toLowerCase() === "pending")
            badge.classList.add("kyc-pending");

        if (status.toLowerCase() === "approved")
            badge.classList.add("kyc-approved");

        if (status.toLowerCase() === "rejected")
            badge.classList.add("kyc-rejected");

        document.getElementById("kycMenu").style.display = "none";
    }
</script>